/*! For license information please see 953.289c8f0d.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkpersonal_finance_tracker=self.webpackChunkpersonal_finance_tracker||[]).push([[953],{8334:(t,e,a)=>{a.r(e),a.d(e,{default:()=>p});var n=a(9379),s=a(5043),r=a(6983),o=a(920),i=a(5349),c=a(7669),l=a(7750),d=a(3709),u=a(205),m=a(885),h=a(9554),y=a(579);const p=()=>{const[t,e]=(0,s.useState)(null),{theme:a,setTheme:p}=(0,u.D)(),[g,f]=(0,s.useState)(!1),[w,b]=(0,s.useState)(null),[x,k]=(0,s.useState)(!1),[_,v]=(0,s.useState)(null),[A,I]=(0,s.useState)(!1);(0,s.useEffect)((()=>{f(!0)}),[]),(0,s.useEffect)((()=>{(async()=>{const{data:{user:t}}=await d.A.auth.getUser();if(t){e(t.id);const{data:n}=await d.A.from("profiles").select("simplefin_access_url").eq("id",t.id).single();if(null!==n&&void 0!==n&&n.simplefin_access_url)try{const e=(0,m.jO)(n.simplefin_access_url,t.id);e&&e.startsWith("http")&&b(e)}catch(a){console.error("Error decrypting SimpleFin URL:",a)}}})()}),[]);const j=async e=>{try{const{data:a}=await d.A.from("purchases").select("simplefin_transaction_id, simplefin_account_id, is_deleted").eq("user_id",t),{transactionsToCreate:s}=await(0,h.fm)(w,e,a||[]);if(0===s.length)return void console.log("No new transactions to sync");console.log("Syncing ".concat(s.length," new transactions"));for(const e of s)await d.A.from("purchases").insert([(0,n.A)((0,n.A)({},e),{},{user_id:t})]);console.log("Successfully synced ".concat(s.length," transactions"))}catch(a){console.error("Transaction sync error:",a)}};return(0,y.jsxs)("div",{className:"w-full mx-auto p-6 bg-white dark:bg-slate-800 shadow-lg rounded-lg",children:[(0,y.jsx)("h1",{className:"text-3xl font-bold text-center text-gray-800 dark:text-white mb-6",children:"Settings"}),(0,y.jsxs)("div",{className:"space-y-4",children:[g&&(0,y.jsxs)("div",{className:"flex items-center justify-between p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-md",children:[(0,y.jsxs)("div",{children:[(0,y.jsx)("h3",{className:"text-sm font-medium text-gray-900 dark:text-white",children:"Dark Mode"}),(0,y.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Toggle dark/light theme"})]}),(0,y.jsx)("button",{onClick:()=>p("dark"===a?"light":"dark"),className:"p-2 rounded-lg bg-gray-200 dark:bg-slate-600 hover:bg-gray-300 dark:hover:bg-slate-500 transition-colors","aria-label":"Toggle theme",children:"dark"===a?(0,y.jsx)(r.A,{className:"w-5 h-5 text-gray-700 dark:text-gray-200"}):(0,y.jsx)(o.A,{className:"w-5 h-5 text-gray-700 dark:text-gray-200"})})]}),w&&(0,y.jsxs)("div",{className:"border-t border-gray-200 dark:border-gray-600 pt-4 pb-4 space-y-3",children:[(0,y.jsx)("h3",{className:"text-sm font-semibold text-gray-900 dark:text-white mb-2",children:"SimpleFin Sync"}),(0,y.jsxs)("button",{onClick:async()=>{if(w&&t){k(!0);try{const{data:e}=await d.A.from("accounts").select("*").eq("user_id",t),a=(e||[]).map((e=>(0,n.A)((0,n.A)({},e),{},{value:(0,m.pN)(e.value,t),interest_rate:(0,m.pN)(e.interest_rate,t),montly_contribution:(0,m.pN)(e.montly_contribution,t)}))),{accountsToCreate:s,accountsToUpdate:r}=await(0,h.cw)(w,a);console.log("Sync results:",{toCreate:s.length,toUpdate:r.length,newAccounts:s});const o=[];for(const c of s){console.log("Creating new account:",c);const e=(0,m.Rb)(c.value,t),a=(0,m.Rb)(c.interest_rate,t),s=(0,m.Rb)(c.montly_contribution,t),{data:r,error:i}=await d.A.from("accounts").insert([(0,n.A)((0,n.A)({},c),{},{value:e,interest_rate:a,montly_contribution:s,user_id:t})]).select();if(i)throw console.error("Error inserting account:",i),i;console.log("Account created successfully:",r),r&&r[0]&&o.push((0,n.A)((0,n.A)({},r[0]),{},{value:c.value,interest_rate:c.interest_rate,montly_contribution:c.montly_contribution}))}for(const n of r){const e=(0,m.Rb)(n.value,t),a=(0,m.Rb)(n.interest_rate,t),s=(0,m.Rb)(n.montly_contribution,t);await d.A.from("accounts").update({value:e,interest_rate:a,montly_contribution:s,account_type:n.account_type,type:n.type,last_synced:n.last_synced,is_simplefin_synced:!0}).eq("id",n.id)}const i=[...a,...o];await j(i),v(new Date)}catch(e){console.error("SimpleFin sync error:",e),alert("Failed to sync accounts. Please try again.")}finally{k(!1)}}},disabled:x,className:"w-full flex items-center justify-center gap-2 p-3 text-sm font-medium text-white bg-green-600 dark:bg-green-700 hover:bg-green-700 dark:hover:bg-green-800 rounded-md transition-colors disabled:opacity-50",children:[(0,y.jsx)(i.A,{className:"w-4 h-4 ".concat(x?"animate-spin":"")}),x?"Syncing...":"Sync Accounts Now"]}),_&&(0,y.jsxs)("p",{className:"text-xs text-gray-500 dark:text-gray-400 text-center",children:["Last synced: ",_.toLocaleTimeString()]}),(0,y.jsxs)("button",{onClick:()=>I(!0),className:"w-full flex items-center justify-center gap-2 p-2 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-md transition-colors",children:[(0,y.jsx)(c.A,{className:"w-4 h-4"}),"Disconnect SimpleFin"]})]}),(0,y.jsx)("div",{className:"border-t border-gray-200 dark:border-gray-600 pt-4",children:(0,y.jsxs)("button",{onClick:async()=>{try{const{error:t}=await d.A.auth.signOut();if(t)throw t;window.location.href="/"}catch(t){console.error("Error signing out:",t)}},className:"w-full flex items-center justify-center gap-2 p-2 text-sm font-medium text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-md transition-colors",children:[(0,y.jsx)(l.A,{className:"w-4 h-4"}),"Sign Out"]})})]}),A&&(0,y.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:(0,y.jsxs)("div",{className:"bg-white dark:bg-slate-800 rounded-lg shadow-2xl max-w-md w-full p-6",children:[(0,y.jsx)("h3",{className:"text-xl font-bold text-gray-800 dark:text-white mb-4",children:"Disconnect SimpleFin?"}),(0,y.jsx)("p",{className:"text-gray-600 dark:text-gray-300 mb-6",children:"Your synced accounts will remain, but they will no longer automatically update. You can reconnect SimpleFin anytime from the Accounts page."}),(0,y.jsxs)("div",{className:"flex gap-3",children:[(0,y.jsx)("button",{onClick:()=>I(!1),className:"flex-1 px-4 py-2.5 bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-gray-200 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-slate-600 transition-colors",children:"Cancel"}),(0,y.jsx)("button",{onClick:async()=>{try{await d.A.from("profiles").update({simplefin_access_url:null}).eq("id",t),b(null),v(null),I(!1)}catch(e){console.error("Error disconnecting SimpleFin:",e),alert("Failed to disconnect SimpleFin.")}},className:"flex-1 px-4 py-2.5 bg-red-500 dark:bg-red-600 hover:bg-red-600 dark:hover:bg-red-700 text-white rounded-lg font-medium transition-colors",children:"Disconnect"})]})]})})]})}},9554:(t,e,a)=>{a.d(e,{Mc:()=>s,cw:()=>l,fm:()=>d});var n=a(9379);async function s(t){try{const e=atob(t.trim());if(!e.startsWith("http"))throw new Error("Invalid setup token format");const a="https://gzuyfuwdajaqwvkcptuf.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6dXlmdXdkYWphcXd2a2NwdHVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc5MzkwMjYsImV4cCI6MjA1MzUxNTAyNn0.bm_usDFy_wYZtI643RAEYxrl24jk6CYtYVwWjpMaZGI",s=await fetch("".concat(a,"/functions/v1/simplefin-proxy"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(n)},body:JSON.stringify({url:e,method:"POST"})}),r=await s.text();if(!s.ok){if(429===s.status)throw new Error("RATE_LIMIT: Too many requests. Please wait a moment and try again.");throw new Error("Edge Function error (".concat(s.status,"): ").concat(r))}const o=r;if(!o||!o.startsWith("http"))throw new Error("Invalid response from SimpleFin");return o.trim()}catch(e){if("RATE_LIMIT"===e.message)throw e;if("InvalidCharacterError"===e.name)throw new Error("Invalid setup token. Please check and try again.");throw new Error("Failed to claim access URL: ".concat(e.message))}}async function r(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{if(!t||!t.startsWith("http"))throw new Error("Invalid access URL");let a="".concat(t,"/accounts");const n=[];e.startDate&&n.push("start-date=".concat(e.startDate)),e.endDate&&n.push("end-date=".concat(e.endDate)),n.length>0&&(a+="?".concat(n.join("&")));const s="https://gzuyfuwdajaqwvkcptuf.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6dXlmdXdkYWphcXd2a2NwdHVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc5MzkwMjYsImV4cCI6MjA1MzUxNTAyNn0.bm_usDFy_wYZtI643RAEYxrl24jk6CYtYVwWjpMaZGI",o=await fetch("".concat(s,"/functions/v1/simplefin-proxy"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(r)},body:JSON.stringify({url:a,method:"GET"})});if(!o.ok){if(429===o.status){const t=o.headers.get("Retry-After");throw new Error("RATE_LIMIT:".concat(t||"60"))}if(401===o.status||403===o.status)throw new Error("UNAUTHORIZED: Access URL is invalid or expired. Please reconnect SimpleFin.");throw new Error("Failed to fetch accounts: ".concat(o.statusText))}return await o.json()}catch(a){if(a.message.startsWith("RATE_LIMIT")||a.message.startsWith("UNAUTHORIZED"))throw a;throw new Error("Failed to fetch accounts: ".concat(a.message))}}function o(t){var e;let a=0;void 0!==t.balance&&null!==t.balance&&(a=parseFloat(t.balance)),0===a&&void 0!==t.available_balance&&null!==t.available_balance&&(a=parseFloat(t.available_balance));let n="other";const s=(null===(e=t.name)||void 0===e?void 0:e.toLowerCase())||"";return s.includes("checking")||s.includes("debit")?n="checking":s.includes("savings")?n="savings":s.includes("credit")||a<0?n="credit":s.includes("loan")||s.includes("mortgage")?n="loan":(s.includes("investment")||s.includes("brokerage")||s.includes("401k")||s.includes("ira"))&&(n="investment"),"credit"!==n&&"loan"!==n||(a=Math.abs(a)),{simplefin_id:t.id,name:t.name||"Unnamed Account",account_type:n,value:a,is_simplefin_synced:!0,last_synced:(new Date).toISOString(),interest_rate:0,montly_contribution:0}}async function i(t){let e,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;for(let s=0;s<a;s++)try{return await t()}catch(n){if(e=n,n.message.startsWith("UNAUTHORIZED")||n.message.includes("Invalid setup token")||n.message.includes("Invalid access URL"))throw n;if(n.message.startsWith("RATE_LIMIT")){const t=n.message.split(":"),e=t.length>1?parseInt(t[1]):60;if(s<a-1){await new Promise((t=>setTimeout(t,1e3*e)));continue}throw n}if(s<a-1){const t=1e3*Math.pow(2,s);await new Promise((e=>setTimeout(e,t)))}}throw e}function c(t,e,a){const n=Math.abs(parseFloat(t.amount)||0);if(t.amount>=0||0===n)return null;let s=new Date;return t.posted?s=new Date(1e3*t.posted):t.transacted_at&&(s=new Date(1e3*t.transacted_at)),{simplefin_transaction_id:t.id,simplefin_account_id:a,item_name:t.description||t.payee||"Unknown Transaction",cost:n,timestamp:s.toISOString(),is_simplefin_synced:!0,budget_item_id:null}}async function l(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];try{const a=await i((()=>r(t)));if(!a||!a.accounts||!Array.isArray(a.accounts))throw new Error("Invalid response format from SimpleFin");const s=[],c=[];for(const t of a.accounts){const a=o(t),r=e.find((t=>t.simplefin_id===a.simplefin_id));r?c.push((0,n.A)((0,n.A)({id:r.id},a),{},{interest_rate:r.interest_rate,montly_contribution:r.montly_contribution,name:r.name||a.name})):s.push(a)}return{accountsToCreate:s,accountsToUpdate:c,totalSynced:a.accounts.length,rawData:a}}catch(a){throw a}}async function d(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];try{const n=Math.floor(Date.now()/1e3),s=n-7776e3,o=await i((()=>r(t,{startDate:s,endDate:n})));if(!o||!o.accounts||!Array.isArray(o.accounts))throw new Error("Invalid response format from SimpleFin");const l=[],d=new Set(a.filter((t=>t.simplefin_transaction_id)).map((t=>t.simplefin_transaction_id)));for(const t of o.accounts){const a=e.find((e=>e.simplefin_id===t.id));if(a&&(t.transactions&&Array.isArray(t.transactions)))for(const e of t.transactions){if(d.has(e.id))continue;const n=c(e,a.id,t.id);n&&l.push(n)}}return{transactionsToCreate:l,totalSynced:l.length}}catch(n){throw n}}},7750:(t,e,a)=>{a.d(e,{A:()=>n});const n=(0,a(1114).A)("LogOut",[["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}],["polyline",{points:"16 17 21 12 16 7",key:"1gabdz"}],["line",{x1:"21",x2:"9",y1:"12",y2:"12",key:"1uyos4"}]])},920:(t,e,a)=>{a.d(e,{A:()=>n});const n=(0,a(1114).A)("Moon",[["path",{d:"M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z",key:"a7tn18"}]])},5349:(t,e,a)=>{a.d(e,{A:()=>n});const n=(0,a(1114).A)("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]])},6983:(t,e,a)=>{a.d(e,{A:()=>n});const n=(0,a(1114).A)("Sun",[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]])},7669:(t,e,a)=>{a.d(e,{A:()=>n});const n=(0,a(1114).A)("X",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]])}}]);
//# sourceMappingURL=953.289c8f0d.chunk.js.map